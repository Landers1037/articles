---
title: 常见网络协议
name: network-protocol
date: 2020-03-10
id: 0
tags: [linux]
categories: []
abstract: ""
---


常见的网络协议TCP/UDP，pop3，imap，smtp，ftp


<!--more-->


常见的网络协议TCP/UDP，pop3，imap，smtp，ftp

<!--more-->

## tcp/ip

`tcp/ip`协议是一个族群，包含的各种协议运行于不同的OSI层

传输层`tcp/udp`，应用层`http,smtp,ftp,telnet`，路由控制协议`RIP,OSPF,BGP`，网际协议`IP,ICMP,ARP`

**数据包**

数据包由两部分组成，该层传输用到的协议首部，来自上层传输来的数据

**端口号**

同一主机上的程序之间的通信使用端口号完成，端口号就类似于程序的地址

不同主机之间的通信通过IP地址，源端口号，目标端口号，协议号区分

### tcp/udp

`tcp`是传输控制协议，面向连接的可靠服务。拥有高级的功能比如流量控制，拥塞控制

`udp`是用户数据报，十分简单适用于广播，包较小的传输，即时传输(视频，聊天)

区别是tcp是面向连接的可靠传输而udp是无连接的

#### 三次握手

`tcp`协议建立连接需要三次握手

1. 客户端发送标志位`SYN=1`，一个随机值`seq=j`给服务器
2. 服务器接收后，标志位`SYN=1`，应答位`ACK=1`，`ack=j+1`，随机产生`seq=k`
3. 客户端接收到来自服务器的响应，检查`ack`是否为**j+1**，验证成功应答位`ACK=1`，`ack=k+1`，进入ESTABLISHED状态建立连接

#### 四次挥手

挥手为4次是因为数据传输导致的

1. 客户端发送终止位`FIN=M`，请求断开连接(wait状态即客户端无信息发送)
2. 服务器收到后返回`ack=M+1`进入wait状态即服务器检查自身是否准备好断开连接
3. 服务器发送`FIN=N`信号，告诉客户端数据已经传输完成(进入LAST_ACK等待客户端断开)
4. 客户端收到`FIN`，返回`ACK=1`，`ack=N+1`告诉服务器可以关闭连接了(如果服务器收到ack则断开连接，如果没有收到可以选择重传数据)

### pop3/imap/smtp

`pop3`邮件访问协议，用于邮件的接收，即用户邮件接收请求协议，单向的即用户删除本地的邮件，邮件服务器上的邮件不会被删除

`imap`邮件访问协议，比pop3更高级，是双向的，和pop3都是基于tcp的协议

`smtp`邮件传输协议，用于遵循特定规则发送邮件

**一封邮件的发送过程**

发送方必须先发出请求

1. 发送方通过`smtp`协议发送邮件到自己所属的服务器
2. 服务器通过`smtp`协议发送这个邮件到接收方所属服务器，接收方把邮件保存到对应的用户邮件空间
3. 发送方服务器在发送后会通知接收方收取
4. 接收方收取时使用`pop3`协议连接到自己的邮件空间，查看邮件，`pop3`会将服务器上的邮件下载到本地。同时服务器上的邮件会被删除。它不能删除服务器上的邮件

**使用imap**

`imap`作为比`pop3`优秀的协议，解决了从服务器下载邮件，删除邮件，询问是否有新的邮件。可以决定先下载哪些邮件，或只是先下载邮件名称标题，在用户打开时再下载内容

**注意**，如果发信方和收信方属于一个域，例如a@gmail.com和b@gmail.com互发邮件，则再smtp服务器接收到发信方的邮件后会直接发送给本地的pop3服务器

### ftp

`ftp`即文件传输协议

ftp使用两个端口分别是数据端口和命令端口，通常为21和20.

命令端口的功能是发送指令和接收返回的状态码，数据端口用于建立连接发送文件

#### 主动和被动模式

一般传输为被动模式，由服务器返回一个连接端口号并进行连接

主动模式则由客户端发送一个端口号给服务器，服务器连接到你的这个端口建立连接

**被动模式**下，客户端发送请求给服务器，客户端开启任意两个端口N和N+1(N>1024),其中第一个端口连接ftp服务器的21端口，第二个端口(N+1)连接服务器开启的任意一个端口N(N>1024)

比如被动模式下服务器建立连接后返回`entering passive mode (127,0,0,1,4,18)`，服务器开放的端口就是**4*256+18**

**主动模式**下，由客户端指定本地开放的端口(N,N+1)给ftp服务器连接，其中N连接到服务器的21端口，N+1连接到服务器的20端口建立数据连接

### shadowsocks

`ss`协议并不是属于专门的协议而是一种加密方式

ss由本地代理，服务器代理组成

浏览器发送请求->本地代理(加密处理)->远程服务器(返回加密的数据包)->本地代理->浏览器

其中浏览器的请求发送属于`http/socket`协议，本地代理只是从请求中取出数据部分加密后发送给服务器，服务器处理后再次加密响应数据包返回给本地代理

